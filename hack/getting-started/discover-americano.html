<!DOCTYPE html><!--[if lte IE 7]> <html class="no-js ie67 ie678" lang="en"> <![endif]-->
<!--[if IE 8]> <html class="no-js ie8 ie678" lang="en"> <![endif]-->
<!--[if IE 9]> <html class="no-js ie9" lang="en"> <![endif]-->
<html lang="en">
  <head>
    <meta charset="utf-8"><!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <link rel="shortcut icon" href="/assets/images/favicon.png">
    <title>Discover Americano
    </title><link  rel="stylesheet" href="/vendors/css/knacss.css" /><link  rel="stylesheet" href="/vendors/css/sunburst.css" /><link  rel="stylesheet" href="/assets/css/main.css" /><link  rel="stylesheet" href="/assets/css/home.css" />
  </head>
  <body>
    <div class="navbar fixed"><a href="/" class="nav-logo left"><img src="/assets/images/happycloud.png" alt="Happy Cloud"></a><span class="subtitle">
        <div class="breadcrumb-item current"><a href="/hack/getting-started/">Getting started</a>
          <ul class="menu-item">
            <li><a href="/hack/getting-started/setup-environment.html">Setting up the environment</a></li>
            <li><a href="/hack/getting-started/first-app.html">Your first app in 30 minutes</a></li>
            <li><a href="/hack/getting-started/architecture-overview.html">Understand the Cozy Architecture</a></li>
            <li><a href="/hack/getting-started/play-with-data-system.html">Play with the Data System</a></li>
            <li><a href="/hack/getting-started/discover-americano.html">Discover Americano</a></li>
            <li><a href="/hack/getting-started/learn-single-page-app-way.html">Learn the Single Page App Way</a></li>
          </ul>
        </div>
        <div class="breadcrumb-item"><a href="/hack/cookbooks/">Cookbooks</a>
          <ul class="menu-item">
            <li><a href="/hack/cookbooks/data-system.html">The Data System API</a></li>
            <li><a href="/hack/cookbooks/data-system-odm.html">The ODM for Data System API</a></li>
            <li><a href="/hack/cookbooks/localization.html">Localize your applications</a></li>
            <li><a href="/hack/cookbooks/deploy.html">Deploy your applications</a></li>
            <li><a href="/hack/cookbooks/nodemon-server-auto-refresh-on-change.html">Using nodemon to auto-refresh the server on code change</a></li>
          </ul>
        </div>
        <div class="breadcrumb-item"><a href="/hack/application-skeletons/">Application Skeletons</a>
          <ul class="menu-item">
            <li><a href="/hack/application-skeletons/cozy-official.html">Official Cozy skeleton</a></li>
          </ul>
        </div>
        <div class="breadcrumb-item"><a href="/hack/contributing/">Contributing</a>
        </div></span>
      <div class="submenu-container right selected"><a href="/hack/getting-started/">Hack</a></div>
      <div class="submenu-container right"><a href="/host/install.html">Host</a></div>
    </div>
    <div class="wrapper">
      <div class="wrap-menu w25 mod left">&nbsp;
        <aside>
          <p class="title toc">Discover Americano</p>
          <nav id="navigation" role="navigation">
            <ul class="nav first-level">
              <li class="big"><a href="#file-structure" class="label">File structure</a>
                <ul class="second-level">
                </ul>
              </li>
              <li class="big"><a href="#define-the-models" class="label">Define the models</a>
                <ul class="second-level">
                </ul>
              </li>
              <li class="big"><a href="#organize-your-code-with-controllers" class="label">Organize your code with Controllers</a>
                <ul class="second-level">
                </ul>
              </li>
              <li class="big"><a href="#routing" class="label">Routing</a>
                <ul class="second-level">
                </ul>
              </li>
              <li class="big"><a href="#configuration" class="label">Configuration</a>
                <ul class="second-level">
                </ul>
              </li>
              <li class="big"><a href="#what-s-next-" class="label">What's next ?</a>
                <ul class="second-level">
                </ul>
              </li>
            </ul>
          </nav>
        </aside>
      </div>
      <div id="main" role="main" class="mod pam w75"><h1 id="discover-americano">Discover Americano</h1>
<p>The more your application grows, the harder it is to maintain. <a href="http://expressjs.com/">Express.js</a> is incredibely powerful, but lacks at helping the developer structuring their code. In order to facilitate development without sacrifying maintainability, let's try <a href="https://github.com/frankrousseau/americano">Americano</a> the framework that makes Express.js more opinionated about configuration and code organization without making it a magician hat ("magic" when it comes to coding is never a good idea).</p>
<p>Americano extends Express: everything that works with Express will work out of the box with Americano. It's really just a matter of convention!</p>
<p>Also, Americano is modular, so you can extend it with plugins. That's what we did with the JugglingDB ODM that comes with the americano-cozy plugin that we are going to use here.</p>
<h3 id="what-you-will-achieve">What you will achieve</h3>
<ul>
<li>Learning a new framework without losing the work you've made so far, by making the bookmark app you've built an Americano app with no effort.</li>
<li>Learning how to painlessly structure your code and improve your capacity to maintain your code.</li>
</ul>
<h3 id="source-code">Source code</h3>
<p>The source code of this tutorial can be found <a href="https://github.com/mycozycloud/cozy-tutorial/tree/americano">here</a>.</p>
<h3 id="getting-stated">Getting stated</h3>
<p>In a brand new application folder, install americano:</p>
<pre class="highlight"><code class="bash">mkdir bookmark-americano &amp;&amp; <span class="hljs-built_in">cd</span> bookmark-americano/
npm install americano --save
npm install americano-cozy --save <span class="hljs-comment"># the plugin that will handle database stuff</span>
</code></pre>
<p>Then put the following in the server.js file:</p>
<pre class="highlight"><code class="javascript"><span class="hljs-comment">// ./server.js</span>
<span class="hljs-keyword">var</span> americano = <span class="hljs-built_in">require</span>(<span class="hljs-string">'americano'</span>);

<span class="hljs-keyword">var</span> port = process.env.PORT || <span class="hljs-number">9250</span>;
americano.start({name: <span class="hljs-string">'yourapp'</span>, port: port});
</code></pre>
<p>We're done! We said no effort, but still!</p>
<h2 id="file-structure">File structure</h2>
<p>Americano constrains the way your file structure should be, let's see how:</p>
<ul>
<li>client/ - all your client files (templates...)</li>
<li>public/ - all your public assets (images, css, javascript)</li>
<li>server/<ul>
<li>controllers/ - we'll come back on what controllers are<ul>
<li>routes.js - we'll come back on what the router is</li>
</ul>
</li>
<li>models/ - we'll see how to define a model<ul>
<li>requests.js - where you put the requests to access your data</li>
</ul>
</li>
<li>config.js - Americano configuration</li>
</ul>
</li>
<li>package.json : holds your app information and dependencies</li>
<li>server.js : the application starter</li>
</ul>
<p>Note that Americano makes the "server" structure mandatory but let you do whatever you want with the client/public folders.</p>
<p>You might recognize familiar concepts: Model, Controller and somehow the View. It is important you understand that even if Americano doesn't actually put shiny MVC into Express, it brings separation of concerns to application, which is what really matters.</p>
<p>Start by creating the architecture, then we'll move on the models' creation.</p>
<h2 id="define-the-models">Define the models</h2>
<p>The models folder allows you to put the doctype definition in separate files. Let's take the code we previously had in server.js and move it to <code>server/models/bookmark.js</code>:</p>
<pre class="highlight"><code class="javascript">americano = <span class="hljs-built_in">require</span>(<span class="hljs-string">'americano'</span>);

<span class="hljs-comment">// The americano plugin wraps the "db.define" JugglingDB function in a simpler "getModel" call</span>
module.exports = Bookmark = americano.getModel(<span class="hljs-string">'bookmarks'</span>, {
  <span class="hljs-string">"id"</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-string">"title"</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-string">"url"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-built_in">String</span>, <span class="hljs-string">"default"</span>: <span class="hljs-string">""</span>}
});

<span class="hljs-comment">// You can easily define here some helpers or method for bookmarks</span>
</code></pre>
<p>Then move to server/models/requests.js so we can define the request we are going to use. The nice part of the Cozy plugin for americano is that it makes requests declaration very clear:</p>
<pre class="highlight"><code class="javascript">module.exports =
  bookmark: {
    all: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> {</span>
      emit(doc._id, doc);
    }
  };
</code></pre>
<p>This will <strong>automatically</strong> trigger the old "Bookmark.defineRequest" when the server starts. Americano's Cozy plugin knows that the "all request" is often the same and offers this handy shortcut:</p>
<pre class="highlight"><code class="javascript">americano = <span class="hljs-built_in">require</span>(<span class="hljs-string">'americano'</span>);

module.exports =
  bookmark: {
    all: americano.defaultRequests.all
  };
</code></pre>
<p>You can now add a helper to your bookmark model (we'll use it in the next section):</p>
<pre class="highlight"><code class="javascript"><span class="hljs-comment">// server/models/bookmark.js</span>

Bookmark.all = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
  Bookmark.request(<span class="hljs-string">"all"</span>, {}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, bookmarks)</span> {</span>
    callback(<span class="hljs-literal">null</span>, bookmarks);
  });
};
</code></pre>
<p>Now let's focus on the business logic of your application.</p>
<h2 id="organize-your-code-with-controllers">Organize your code with Controllers</h2>
<p>Create the bookmark controller: server/controllers/bookmarks.js</p>
<pre class="highlight"><code class="javascript">Bookmark = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/bookmark'</span>);

module.exports.list = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span> {</span>
  Bookmark.all(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, bookmarks)</span> {</span>
    <span class="hljs-keyword">if</span>(err != <span class="hljs-literal">null</span>) {
      res.send(<span class="hljs-number">500</span>, <span class="hljs-string">"An error has occurred -- "</span> + err);
    }
    <span class="hljs-keyword">else</span> {
      data = {<span class="hljs-string">"bookmarks"</span>: bookmarks}
      res.render(<span class="hljs-string">'index.jade'</span>, data, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, html)</span> {</span>
        res.send(<span class="hljs-number">200</span>, html);
      });
    }
  });
};

<span class="hljs-comment">// We define a new route that will handle bookmark creation</span>
module.exports.add = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span> {</span>
  Bookmark.create(req.body, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, bookmark)</span> {</span>
    <span class="hljs-keyword">if</span>(err != <span class="hljs-literal">null</span>) {
      res.send(<span class="hljs-number">500</span>, <span class="hljs-string">"An error has occurred -- "</span> + err);
    }
    <span class="hljs-keyword">else</span> {
      res.redirect(<span class="hljs-string">'back'</span>);
    }
  });
};

<span class="hljs-comment">// We define another route that will handle bookmark deletion</span>
module.exports.delete = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span> {</span>
  Bookmark.find(req.params.id, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, bookmark)</span> {</span>
    <span class="hljs-keyword">if</span>(err != <span class="hljs-literal">null</span>) {
      res.send(<span class="hljs-number">500</span>, <span class="hljs-string">"Bookmark couldn't be retrieved -- "</span> + err);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(bookmark == <span class="hljs-literal">null</span>) {
      res.send(<span class="hljs-number">404</span>, <span class="hljs-string">"Bookmark not found"</span>);
    }
    <span class="hljs-keyword">else</span> {
      bookmark.destroy(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        <span class="hljs-keyword">if</span>(err != <span class="hljs-literal">null</span>) {
          res.send(<span class="hljs-number">500</span>, <span class="hljs-string">"An error has occurred -- "</span> + err);
        }
        <span class="hljs-keyword">else</span> {
          res.redirect(<span class="hljs-string">'back'</span>);
        }
      });
    }
  });
};
</code></pre>
<p>We basically copied and pasted what was in the old server.js, and removed the
"which URL will trigger that action" part to focus on the code itself.</p>
<p>You probably noticed the "require" instruction. It loads the bookmark model we</p>
<p>defined earlier. More precisely, it loads what has previously been module.exports'ed (this
is NodeJS stuff, abuse that to create small modules of code).</p>
<p>Don't hesitate to split your code in multiple coherent controllers (one for
bookmarks, one for tags, ...)!</p>
<h2 id="routing">Routing</h2>
<p>There is still one very important missing thing, the routes. The routes are the
"which URL will trigger which action" information.</p>
<p>We put them in a dedicated file, so you don't have to look at every single
controllers when you are looking for a specific piece of code. Just check the
routes, they are the map of your application.</p>
<p>Americano <strong>automatically</strong> handles their loading when the server starts and
makes their syntax handy:</p>
<pre class="highlight"><code class="javascript"><span class="hljs-comment">// ./server/controllers/routes.js</span>

<span class="hljs-keyword">var</span> bookmarks = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./bookmarks'</span>);

module.exports = {
  <span class="hljs-string">''</span>: {
    get: bookmarks.list
  },
  <span class="hljs-string">'add'</span>: {
    post: bookmarks.add
  },
  <span class="hljs-string">'delete/:id'</span>: {
    get: bookmarks.delete
  }
};
</code></pre>
<p>Please note that every "route" is <strong>automatically</strong> prefixed by a '/' so you don't need to put it yourself.</p>
<p>You can also bind different HTTP verbs to the same route:</p>
<pre class="highlight"><code class="javascript"><span class="hljs-comment">// this example will not work with the code you have, you must change the template for that</span>
module.exports = {
  <span class="hljs-string">'bookmarks'</span>: {
    get: bookmarks.list
    post: bookmarks.add
  },
};
</code></pre>
<h2 id="configuration">Configuration</h2>
<p>Now our application should already be working but there is one thing we left aside: configuration.</p>
<p>Again, Americano will provide you a handy syntax and loads everything <strong>automatically</strong> at start:</p>
<pre class="highlight"><code class="javascript"><span class="hljs-comment">// ./server/config.js</span>

<span class="hljs-keyword">var</span> americano = <span class="hljs-built_in">require</span>(<span class="hljs-string">'americano'</span>);

module.exports = {
  common: [
    americano.bodyParser(),
    americano.methodOverride(),
    americano.errorHandler({
      dumpExceptions: <span class="hljs-literal">true</span>,
      showStack: <span class="hljs-literal">true</span>
    }),
    americano.static(__dirname + <span class="hljs-string">'/../public'</span>, {
      maxAge: <span class="hljs-number">86400000</span>
    }),
    americano.set(<span class="hljs-string">'views'</span>, __dirname + <span class="hljs-string">'/../client'</span>),
    americano.engine(<span class="hljs-string">'.html'</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">'jade'</span>).__express)
  ],
  development: [
    americano.logger(<span class="hljs-string">'dev'</span>)
  ],
  production: [
    americano.logger(<span class="hljs-string">'short'</span>)
  ]
};
</code></pre>
<p>The configuration works exactly like in Express (remember, Americano extends
Express!), so be sure to change it the way you like.</p>
<h2 id="what-s-next-">What's next ?</h2>
<p>We splitted our application into logical pieces and it can now grow without us
worrying about coming back later to make modification and being completely
lost.</p>
<p>You discovered Americano, our favorite framework, but you can use the one you
like, stick with ExpressJS or check out <a href="http://flatironjs.org/">Flatiron</a>,
<a href="http://sailsjs.org/">Sails.js</a> or <a href="http://compoundjs.com/">Compound.js</a>.  As we constantly like to say, a Cozy app is nothing more than a web app.</p>
<p>We are almost done with Cozy's basics, there is still one concept
we'd like to introduce you to. Are you ready to <a href="/hack/getting-started/learn-single-page-app-way.html">learn the single page app
way</a>?</p>

      </div>
      <footer id="footer" role="contentinfo" class="line pam row"><a href="https://github.com/mycozycloud">Github</a><a href="irc://irc.freenode.net/cozycloud">IRC</a><a href="mailto:contact@cozycloud.cc">Contact</a><a href="https://groups.google.com/forum/?fromgroups#!forum/cozy-cloud">Mailing-list</a><a href="https://cozycloud.cc">Cozy Cloud</a></footer>
    </div><script defer="defer"  src="/vendors/javascripts/jquery-2.0.3.min.js"></script><script defer="defer"  src="/vendors/javascripts/bootstrap.min.js"></script><script defer="defer"  src="/assets/javascripts/main.js"></script>
  </body>
</html>