<!DOCTYPE html><!--[if lte IE 7]> <html class="no-js ie67 ie678" lang="en"> <![endif]-->
<!--[if IE 8]> <html class="no-js ie8 ie678" lang="en"> <![endif]-->
<!--[if IE 9]> <html class="no-js ie9" lang="en"> <![endif]-->
<html lang="en">
  <head>
    <meta charset="utf-8"><!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <link rel="shortcut icon" href="/assets/images/favicon.png">
    <title>The ODM for Data System API
    </title><link  rel="stylesheet" href="/vendors/css/knacss.css" /><link  rel="stylesheet" href="/vendors/css/sunburst.css" /><link  rel="stylesheet" href="/assets/css/main.css" /><link  rel="stylesheet" href="/assets/css/home.css" />
  </head>
  <body>
    <div class="navbar fixed"><a href="/" class="nav-logo left"><img src="/assets/images/happycloud.png" alt="Happy Cloud"></a><span class="subtitle">
        <div class="breadcrumb-item"><a href="/hack/getting-started/">Getting started</a>
          <ul class="menu-item">
            <li><a href="/hack/getting-started/setup-environment.html">Setting up the environment</a></li>
            <li><a href="/hack/getting-started/first-app.html">Your first app in 30 minutes</a></li>
            <li><a href="/hack/getting-started/architecture-overview.html">Understand the Cozy Architecture</a></li>
            <li><a href="/hack/getting-started/play-with-data-system.html">Play with the Data System</a></li>
            <li><a href="/hack/getting-started/discover-americano.html">Discover Americano</a></li>
            <li><a href="/hack/getting-started/learn-single-page-app-way.html">Learn the Single Page App Way</a></li>
          </ul>
        </div>
        <div class="breadcrumb-item current"><a href="/hack/cookbooks/">Cookbooks</a>
          <ul class="menu-item">
            <li><a href="/hack/cookbooks/data-system.html">The Data System API</a></li>
            <li><a href="/hack/cookbooks/data-system-odm.html">The ODM for Data System API</a></li>
            <li><a href="/hack/cookbooks/localization.html">Localize your applications</a></li>
            <li><a href="/hack/cookbooks/deploy.html">Deploy your applications</a></li>
            <li><a href="/hack/cookbooks/nodemon-server-auto-refresh-on-change.html">Using nodemon to auto-refresh the server on code change</a></li>
            <li><a href="/hack/cookbooks/components.html">Components</a></li>
            <li><a href="/hack/cookbooks/authentication-authorization-workflows.html">Authentication and Authorization workflows</a></li>
            <li><a href="/hack/cookbooks/encryption.html">Encryption management</a></li>
          </ul>
        </div>
        <div class="breadcrumb-item"><a href="/hack/application-skeletons/">Application Skeletons</a>
          <ul class="menu-item">
            <li><a href="/hack/application-skeletons/cozy-official.html">Official Cozy skeleton</a></li>
          </ul>
        </div>
        <div class="breadcrumb-item"><a href="/hack/contributing/">Contributing</a>
        </div></span>
      <div class="submenu-container right selected"><a href="/hack/getting-started/">Hack</a></div>
      <div class="submenu-container right"><a href="/host/install.html">Host</a></div>
    </div>
    <div class="wrapper">
      <div class="wrap-menu w25 mod left">&nbsp;
        <aside>
          <p class="title toc">The ODM for Data System API</p>
          <nav id="navigation" role="navigation">
            <ul class="nav first-level">
              <li class="big"><a href="#generic-note" class="label">Generic note</a>
                <ul class="second-level">
                </ul>
              </li>
              <li class="big"><a href="#documents" class="label">Documents</a>
                <ul class="second-level">
                </ul>
              </li>
              <li class="big"><a href="#indexation" class="label">Indexation</a>
                <ul class="second-level">
                </ul>
              </li>
              <li class="big"><a href="#files" class="label">Files</a>
                <ul class="second-level">
                </ul>
              </li>
              <li class="big"><a href="#requests" class="label">Requests</a>
                <ul class="second-level">
                </ul>
              </li>
            </ul>
          </nav>
        </aside>
      </div>
      <div id="main" role="main" class="mod pam w75"><h1 id="the-odm-for-data-system-api">The ODM for Data System API</h1>
<p>We've created a driver for JugglingDB, an ODM (Object Document Mapper) to easily work with Cozy Data System. This document will gives you the detailed API to use it, but you can already check <a href="/hack/getting-started/play-with-data-system.html">the tutorial</a> where we introduce it in order to see a working example.</p>
<h2 id="generic-note">Generic note</h2>
<p>Depending on what you use, you might want to install JugglingDB and the Cozy adapter in order to make it works. If you use a framework where it is integrated (like Americano with the Cozy plugin), refers to the framework's documentation too see how to boostrap it. Otherwise, you can follow the steps described in this section.</p>
<pre class="highlight"><code class="bash">npm install jugglindb jugglingdb-cozy-adapter --save
</code></pre>
<p>In the following example, "Note" refers to a model and "note" to a document of the model "Note". "Note" was declared like this:</p>
<pre class="highlight"><code class="javascript"><span class="hljs-keyword">var</span> Schema = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jugglingdb'</span>).Schema,
<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> Schema(<span class="hljs-string">'cozy-adapter'</span>, { url: <span class="hljs-string">'http://localhost:9101/'</span> });

Note = db.define(<span class="hljs-string">'Note'</span>, {
  <span class="hljs-string">"id"</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-string">"title"</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-string">"content"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-built_in">String</span>, <span class="hljs-string">"default"</span>: <span class="hljs-string">""</span>}
});
</code></pre>
<p>Also, you don't have to worry about authentfication and authorization while using the ODM, because they are automatically handled for you.</p>
<h2 id="documents">Documents</h2>
<pre class="highlight"><code class="javascript"><span class="hljs-comment">// Checking document existence</span>
Note.exists(<span class="hljs-number">123</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, isExist)</span> {</span>
    console.log(isExist);
});

<span class="hljs-comment">// Retrieving a document with its ID</span>
Note.find(<span class="hljs-number">321</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, note)</span> {</span>
    console.log(note);
});

<span class="hljs-comment">// Creating a document</span>
Note.create({ id: <span class="hljs-string">"321"</span>, <span class="hljs-string">"content"</span>:<span class="hljs-string">"created value"</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, note)</span> {</span>
    console.log(note.id);
});

<span class="hljs-comment">// Upserting (update or create if doesn't exist) a document</span>
Note.createOrUpdate(<span class="hljs-number">123</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, note)</span> {</span>
    console.log(err);
});

<span class="hljs-comment">// Updating a document (will replace the existing one)</span>
note.save(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
    console.log(err);
});

<span class="hljs-comment">// Updating attributes (only replace the specified attributes)</span>
note.updateAttributes({title: <span class="hljs-string">"my new title"</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
    console.log(err);
});

<span class="hljs-comment">// Deleting a document</span>
note.destroy(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
    console.log(err);
});
</code></pre>
<h2 id="indexation">Indexation</h2>
<pre class="highlight"><code class="javascript"><span class="hljs-comment">// Indexing document fields</span>
note.index([<span class="hljs-string">"title"</span>, <span class="hljs-string">"content"</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
    console.log(err);
});

<span class="hljs-comment">// Searching the 10 most relevant indexed documents</span>
Note.search(<span class="hljs-string">"dragons"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, notes)</span> {</span>
   console.log(notes);
});
</code></pre>
<h2 id="files">Files</h2>
<pre class="highlight"><code class="javascript"># Uploading/attaching a file to a document
note.attachBinary(<span class="hljs-string">"./test.png"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
    console.log(err);
});

# Get the file
stream = note.getBinary(<span class="hljs-string">"test.png"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
    console.log(err);
});
stream.pipe(fs.createWriteStream(<span class="hljs-string">'./test.png'</span>));

# Save the file to the disk
<span class="hljs-keyword">var</span> path = <span class="hljs-string">"/tmp/test.png"</span>;
note.saveBinary(<span class="hljs-string">"test.png"</span>, path, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
    console.log(err);
});

# Remove the file
note.removeBinary(<span class="hljs-string">"test.png"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
    console.log(err);
});
</code></pre>
<h2 id="requests">Requests</h2>
<pre class="highlight"><code class="javascript"># Defining request
map = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> {</span>
    emit(doc._id, doc);
    <span class="hljs-keyword">return</span>;
}

Note.defineRequest(<span class="hljs-string">"all"</span>, map, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
    console.log(err);
});

# Getting request results
Note.request(<span class="hljs-string">"all"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, notes)</span> {</span>
    console.log(notes);
});

# Destroying all documents of a request result
Note.requestDestroy(<span class="hljs-string">"all"</span>, {key: ids[<span class="hljs-number">3</span>]}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
    console.log(err);
});

# Removing a request
Note.removeRequest(<span class="hljs-string">"all"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
    console.log(err);
});
</code></pre>

      </div>
      <footer id="footer" role="contentinfo" class="line pam row"><a href="https://github.com/mycozycloud">Github</a><a href="irc://irc.freenode.net/cozycloud">IRC</a><a href="mailto:contact@cozycloud.cc">Contact</a><a href="https://groups.google.com/forum/?fromgroups#!forum/cozy-cloud">Mailing-list</a><a href="https://cozycloud.cc">Cozy Cloud</a></footer>
    </div><script defer="defer"  src="/vendors/javascripts/jquery-2.0.3.min.js"></script><script defer="defer"  src="/vendors/javascripts/bootstrap.min.js"></script><script defer="defer"  src="/assets/javascripts/main.js"></script>
  </body>
</html>